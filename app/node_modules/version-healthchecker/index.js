var
  express = require('express'),
  app = express(),
  logger = require('bunyan-request-logger'),
  noCache = require('connect-cache-control'),
  version = require('version-healthcheck');

var log = logger();

// Expose the logger so that requiring modules can
// use it.
app.log = log;

// Automatically log all incoming requests with
// response data and request ids.
app.use( log.requestLogger() );

// Remove X-Powered-By header from all responses
app.disable('x-powered-by');

// Route to handle client side log messages.
//
// This route prepends the cache-control
// middleware so that the browser always logs
// to the server instead of fetching a useless
// OK message from its cache.
// 
// Using a 1x1 transparent gif allows you to
// use the logger in emails or embed the tracking
// pixel on third party sites without resorting
// to JavaScript.
app.get( '/log.gif', noCache, log.route() );

// Version healthcheck route
//
// Responds with app name and version from 
// package.json, and latest git build hash.
//
// Useful for monitoring the health status of 
// your application deployments.
app.get( '/version', noCache, version );

module.exports = app;
